{% extends 'marketing/base.html' %}
{% load static %}

{% block title %}Create Purchase Order - Marketing Hub{% endblock %}

{% block content %}
<div class="mx-auto w-full p-2 md:p-4 xl:p-2">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Create Purchase Order</h1>
                <p class="text-sm text-gray-600">Create a new purchase order for customer</p>
            </div>
            <a href="{% url 'marketing:po_list' %}" class="inline-flex items-center gap-2 rounded-lg bg-white border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                Back to Purchase Orders
            </a>
        </div>
    </div>

    <!-- PO Form -->
    <div class="rounded-lg border border-gray-200 bg-white shadow-sm">
        <form method="post" enctype="multipart/form-data" class="p-6 space-y-6">
            {% csrf_token %}
            
            <!-- Basic Information -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="po_number" class="block text-sm font-medium text-gray-700 mb-2">
                        PO Number <span class="text-red-500">*</span>
                    </label>
                    <input type="text" name="po_number" id="po_number" required 
                           class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:border-brand-500 focus:outline-none focus:ring-1 focus:ring-brand-500" 
                           placeholder="e.g., PO-2024-001">
                </div>
                
                <div>
                    <label for="customer" class="block text-sm font-medium text-gray-700 mb-2">
                        Customer <span class="text-red-500">*</span>
                    </label>
                    <select name="customer" id="customer" required 
                            class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:border-brand-500 focus:outline-none focus:ring-1 focus:ring-brand-500">
                        <option value="">Select Customer</option>
                        {% for customer in customers %}
                        <option value="{{ customer.id }}">{{ customer.name }} - {{ customer.contact_person }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Quotation and Amount -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="quotation" class="block text-sm font-medium text-gray-700 mb-2">Quotation</label>
                    <select name="quotation" id="quotation" 
                            class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:border-brand-500 focus:outline-none focus:ring-1 focus:ring-brand-500">
                        <option value="">Select Quotation (Optional)</option>
                        {% for quotation in quotations %}
                        <option value="{{ quotation.id }}">{{ quotation.quotation_number }} - {{ quotation.customer.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label for="total_amount" class="block text-sm font-medium text-gray-700 mb-2">
                        Total Amount (₹) <span class="text-red-500">*</span>
                    </label>
                    <input type="number" name="total_amount" id="total_amount" step="0.01" required 
                           class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:border-brand-500 focus:outline-none focus:ring-1 focus:ring-brand-500" 
                           placeholder="0.00">
                </div>
            </div>

            <!-- Dates -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="received_date" class="block text-sm font-medium text-gray-700 mb-2">
                        Received Date <span class="text-red-500">*</span>
                    </label>
                    <input type="date" name="received_date" id="received_date" required 
                           class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:border-brand-500 focus:outline-none focus:ring-1 focus:ring-brand-500">
                </div>
                
                <div>
                    <label for="delivery_date" class="block text-sm font-medium text-gray-700 mb-2">
                        Delivery Date <span class="text-red-500">*</span>
                    </label>
                    <input type="date" name="delivery_date" id="delivery_date" required 
                           class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:border-brand-500 focus:outline-none focus:ring-1 focus:ring-brand-500">
                </div>
            </div>

            <!-- Payment Information -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="payment_method" class="block text-sm font-medium text-gray-700 mb-2">Payment Method</label>
                    <select name="payment_method" id="payment_method" 
                            class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:border-brand-500 focus:outline-none focus:ring-1 focus:ring-brand-500">
                        <option value="">Select Payment Method</option>
                        <option value="advance">Advance Payment</option>
                        <option value="credit">Credit Payment</option>
                        <option value="l_c">Letter of Credit</option>
                        <option value="bank_guarantee">Bank Guarantee</option>
                        <option value="cheque">Cheque</option>
                        <option value="neft_rtgs">NEFT/RTGS</option>
                        <option value="cash">Cash</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div>
                    <label for="payment_terms" class="block text-sm font-medium text-gray-700 mb-2">Payment Terms</label>
                    <input type="text" name="payment_terms" id="payment_terms" 
                           class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:border-brand-500 focus:outline-none focus:ring-1 focus:ring-brand-500" 
                           placeholder="e.g., 50% advance, 50% on delivery">
                </div>
            </div>

            <!-- Payment Terms Declared -->
            <div>
                <label for="payment_terms_declared" class="block text-sm font-medium text-gray-700 mb-2">Payment Terms Declared by Customer</label>
                <textarea name="payment_terms_declared" id="payment_terms_declared" rows="3" 
                          class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:border-brand-500 focus:outline-none focus:ring-1 focus:ring-brand-500" 
                          placeholder="Enter detailed payment terms as declared by customer..."></textarea>
            </div>

            <!-- Special Requirements -->
            <div>
                <label for="special_requirements" class="block text-sm font-medium text-gray-700 mb-2">Special Requirements</label>
                <textarea name="special_requirements" id="special_requirements" rows="4" 
                          class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:border-brand-500 focus:outline-none focus:ring-1 focus:ring-brand-500" 
                          placeholder="Enter any special requirements, delivery instructions, or notes..."></textarea>
            </div>

            <!-- Form Actions -->
            <div class="flex items-center justify-end gap-3 pt-4 border-t border-gray-200">
                <a href="{% url 'marketing:po_list' %}" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancel
                </a>
                <button type="submit" class="px-6 py-2 bg-brand-600 text-white rounded-lg shadow-sm text-sm font-medium hover:bg-brand-700 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:ring-offset-2">
                    Create Purchase Order
                </button>
            </div>
        </form>
    </div>

    <!-- Help Section -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-6">
        <h4 class="font-medium text-blue-900 mb-2">Purchase Order Guidelines</h4>
        <ul class="text-sm text-blue-800 space-y-1">
            <li>• <strong>PO Number:</strong> Use a consistent numbering system (e.g., PO-YYYY-XXX)</li>
            <li>• <strong>Customer:</strong> Select the customer who placed the order</li>
            <li>• <strong>Quotation:</strong> Link to the approved quotation if available</li>
            <li>• <strong>Total Amount:</strong> Include all costs including taxes and delivery</li>
            <li>• <strong>Payment Terms:</strong> Clearly define payment schedule and methods</li>
            <li>• <strong>Special Requirements:</strong> Note any specific delivery or quality requirements</li>
        </ul>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-generate PO number
    function generatePONumber() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
        return `PO-${year}${month}${day}-${random}`;
    }
    
    // Set default PO number
    document.getElementById('po_number').value = generatePONumber();
    
    // Set default received date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('received_date').value = today;
    
    // Validate date range
    document.getElementById('received_date').addEventListener('change', function() {
        const receivedDate = this.value;
        const deliveryDateField = document.getElementById('delivery_date');
        deliveryDateField.min = receivedDate;
    });
    
    // Format currency input
    document.getElementById('total_amount').addEventListener('blur', function() {
        if (this.value) {
            const value = parseFloat(this.value);
            if (!isNaN(value)) {
                this.value = value.toFixed(2);
            }
        }
    });
});
</script>
{% endblock %}
