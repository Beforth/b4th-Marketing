{% extends 'marketing/base.html' %}
{% load static %}

{% block title %}Create Work Order - Marketing Hub{% endblock %}

{% block content %}
<div class="mx-auto w-full p-2 md:p-4 xl:p-2">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Create Work Order</h1>
                <p class="text-sm text-gray-600">Create a new work order for production</p>
            </div>
            <a href="{% url 'marketing:work_order_format_list' %}" class="inline-flex items-center gap-2 rounded-lg bg-white border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                Back to Work Orders
            </a>
        </div>
    </div>

    <!-- Work Order Form -->
    <div class="rounded-lg border border-gray-200 bg-white shadow-sm">
        <form method="post" enctype="multipart/form-data" class="p-6 space-y-6">
            {% csrf_token %}
            
            <!-- Basic Information -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="work_order_number" class="block text-sm font-medium text-gray-700 mb-2">
                        Work Order Number <span class="text-red-500">*</span>
                    </label>
                    <input type="text" name="work_order_number" id="work_order_number" required 
                           class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:border-brand-500 focus:outline-none focus:ring-1 focus:ring-brand-500" 
                           placeholder="e.g., WO-2024-001">
                </div>
                
                <div>
                    <label for="purchase_order" class="block text-sm font-medium text-gray-700 mb-2">
                        Purchase Order <span class="text-red-500">*</span>
                    </label>
                    <select name="purchase_order" id="purchase_order" required 
                            class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:border-brand-500 focus:outline-none focus:ring-1 focus:ring-brand-500">
                        <option value="">Select Purchase Order</option>
                        {% for po in purchase_orders %}
                        <option value="{{ po.id }}">{{ po.po_number }} - {{ po.customer.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Department and Priority -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="department" class="block text-sm font-medium text-gray-700 mb-2">
                        Department <span class="text-red-500">*</span>
                    </label>
                    <select name="department" id="department" required 
                            class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:border-brand-500 focus:outline-none focus:ring-1 focus:ring-brand-500">
                        <option value="">Select Department</option>
                        <option value="machining">Machining</option>
                        <option value="assembly">Assembly</option>
                        <option value="welding">Welding</option>
                        <option value="painting">Painting</option>
                        <option value="packaging">Packaging</option>
                        <option value="quality_control">Quality Control</option>
                        <option value="testing">Testing</option>
                    </select>
                </div>
                
                <div>
                    <label for="priority" class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                    <select name="priority" id="priority" 
                            class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:border-brand-500 focus:outline-none focus:ring-1 focus:ring-brand-500">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
            </div>

            <!-- Assignment and Due Date -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="assigned_to" class="block text-sm font-medium text-gray-700 mb-2">Assigned To</label>
                    <select name="assigned_to" id="assigned_to" 
                            class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:border-brand-500 focus:outline-none focus:ring-1 focus:ring-brand-500">
                        <option value="">Select Employee (Optional)</option>
                        {% for user in users %}
                        <option value="{{ user.id }}">{{ user.get_full_name|default:user.username }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label for="due_date" class="block text-sm font-medium text-gray-700 mb-2">
                        Due Date <span class="text-red-500">*</span>
                    </label>
                    <input type="date" name="due_date" id="due_date" required 
                           class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:border-brand-500 focus:outline-none focus:ring-1 focus:ring-brand-500">
                </div>
            </div>

            <!-- Description -->
            <div>
                <label for="description" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                <textarea name="description" id="description" rows="3" 
                          class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:border-brand-500 focus:outline-none focus:ring-1 focus:ring-brand-500" 
                          placeholder="Enter work order description and requirements..."></textarea>
            </div>

            <!-- Special Instructions -->
            <div>
                <label for="special_instructions" class="block text-sm font-medium text-gray-700 mb-2">Special Instructions</label>
                <textarea name="special_instructions" id="special_instructions" rows="4" 
                          class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:border-brand-500 focus:outline-none focus:ring-1 focus:ring-brand-500" 
                          placeholder="Enter any special instructions, safety requirements, or notes..."></textarea>
            </div>

            <!-- Form Actions -->
            <div class="flex items-center justify-end gap-3 pt-4 border-t border-gray-200">
                <a href="{% url 'marketing:work_order_format_list' %}" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancel
                </a>
                <button type="submit" class="px-6 py-2 bg-brand-600 text-white rounded-lg shadow-sm text-sm font-medium hover:bg-brand-700 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:ring-offset-2">
                    Create Work Order
                </button>
            </div>
        </form>
    </div>

    <!-- Help Section -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-6">
        <h4 class="font-medium text-blue-900 mb-2">Work Order Guidelines</h4>
        <ul class="text-sm text-blue-800 space-y-1">
            <li>• <strong>Work Order Number:</strong> Use a consistent numbering system (e.g., WO-YYYY-XXX)</li>
            <li>• <strong>Purchase Order:</strong> Select the approved purchase order for this work</li>
            <li>• <strong>Department:</strong> Choose the appropriate department for the work</li>
            <li>• <strong>Priority:</strong> Set priority based on customer requirements and delivery dates</li>
            <li>• <strong>Due Date:</strong> Set realistic completion date based on workload and complexity</li>
            <li>• <strong>Description:</strong> Provide clear description of work to be performed</li>
            <li>• <strong>Special Instructions:</strong> Include any safety, quality, or process requirements</li>
        </ul>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-generate work order number
    function generateWorkOrderNumber() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
        return `WO-${year}${month}${day}-${random}`;
    }
    
    // Set default work order number
    document.getElementById('work_order_number').value = generateWorkOrderNumber();
    
    // Set default due date to 7 days from now
    const dueDate = new Date();
    dueDate.setDate(dueDate.getDate() + 7);
    document.getElementById('due_date').value = dueDate.toISOString().split('T')[0];
    
    // Set minimum due date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('due_date').min = today;
    
    // Auto-populate description based on selected purchase order
    document.getElementById('purchase_order').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            const description = document.getElementById('description');
            if (!description.value) {
                description.value = `Work order for ${selectedOption.text.split(' - ')[1] || 'selected customer'}`;
            }
        }
    });
});
</script>
{% endblock %}
