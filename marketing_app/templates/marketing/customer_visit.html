{% extends 'marketing/base.html' %}
{% load static %}

{% block title %}Record Customer Visit - Marketing Hub{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-2">
        <div>
            <h1 class="text-xl sm:text-2xl font-bold text-gray-900">Record Customer Visit</h1>
            <p class="text-sm sm:text-base text-gray-600">Schedule and record customer visits with GPS tracking</p>
        </div>
        <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
            <a href="{% url 'marketing:visit_list' %}" class="inline-flex items-center justify-center gap-2 rounded-lg bg-white border border-gray-300 px-3 sm:px-4 py-2 text-xs sm:text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                <i data-lucide="list" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                View Visits
            </a>
            <a href="{% url 'marketing:visit_tracking' %}" class="inline-flex items-center justify-center gap-2 rounded-lg bg-white border border-gray-300 px-3 sm:px-4 py-2 text-xs sm:text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                <i data-lucide="navigation" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                Live Tracking
            </a>
        </div>
    </div>

    <!-- GPS Status Card -->
    <div id="gps-status" class="bg-white rounded-xl border border-gray-200 p-4 sm:p-6">
        <div class="flex flex-col sm:flex-row sm:items-center gap-3">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-yellow-100 rounded-lg">
                    <i data-lucide="map-pin" class="w-4 h-4 sm:w-5 sm:h-5 text-yellow-600"></i>
                </div>
                <div class="flex-1">
                    <h4 class="text-sm sm:text-base font-medium text-gray-900">GPS Location</h4>
                    <p class="text-xs sm:text-sm text-gray-600">Capturing your current location for accurate visit tracking</p>
                </div>
            </div>
            <button onclick="captureGPS()" class="inline-flex items-center justify-center gap-2 rounded-lg bg-blue-600 px-3 sm:px-4 py-2 text-xs sm:text-sm font-medium text-white hover:bg-blue-700 transition-colors">
                <i data-lucide="refresh-cw" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                Capture Location
            </button>
        </div>
    </div>

    <!-- Visit Form -->
    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
        <div class="px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200">
            <h3 class="text-base sm:text-lg font-semibold text-gray-900">Visit Details</h3>
        </div>
        
        <form method="post" class="p-4 sm:p-6 space-y-6 sm:space-y-8">
            {% csrf_token %}
            
            <!-- Basic Information -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                <div class="sm:col-span-2">
                    <label for="customer" class="block text-sm font-medium text-gray-700 mb-2">Customer <span class="text-red-500">*</span></label>
                    <select id="customer" name="customer" required
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select customer</option>
                        {% for customer in customers %}
                        <option value="{{ customer.id }}">{{ customer.name }} - {{ customer.contact_person }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label for="visit_date" class="block text-sm font-medium text-gray-700 mb-2">Visit Date <span class="text-red-500">*</span></label>
                    <input type="date" id="visit_date" name="visit_date" required
                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label for="visit_time" class="block text-sm font-medium text-gray-700 mb-2">Visit Time <span class="text-red-500">*</span></label>
                    <input type="time" id="visit_time" name="visit_time" required
                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div class="sm:col-span-2">
                    <label for="purpose" class="block text-sm font-medium text-gray-700 mb-2">Visit Purpose <span class="text-red-500">*</span></label>
                    <select id="purpose" name="purpose" required
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select purpose</option>
                        <option value="cold_call">Cold Call</option>
                        <option value="follow_up">Follow Up</option>
                        <option value="presentation">Presentation</option>
                        <option value="technical_discussion">Technical Discussion</option>
                        <option value="negotiation">Negotiation</option>
                        <option value="exhibition">Exhibition</option>
                        <option value="road_show">Road Show</option>
                    </select>
                </div>
            </div>

            <!-- Visit Participants -->
            <div class="border-t border-gray-200 pt-4 sm:pt-6">
                <h4 class="text-sm sm:text-base font-semibold text-gray-900 mb-3 sm:mb-4">Visit Participants</h4>
                <div class="space-y-3 sm:space-y-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 sm:p-4">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="info" class="w-3 h-3 sm:w-4 sm:h-4 text-blue-600"></i>
                            <span class="text-xs sm:text-sm font-medium text-blue-900">Primary Executive</span>
                        </div>
                        <p class="text-xs sm:text-sm text-blue-700">You ({{ user.get_full_name|default:user.username }}) will be automatically added as the primary executive for this visit.</p>
                    </div>
                    
                    <div id="participants-container">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-0 mb-3">
                            <h5 class="text-xs sm:text-sm font-medium text-gray-700">Additional Participants</h5>
                            <button type="button" onclick="addParticipant()" class="inline-flex items-center justify-center gap-2 rounded-lg bg-blue-600 px-3 py-1.5 text-xs sm:text-sm font-medium text-white hover:bg-blue-700 transition-colors">
                                <i data-lucide="plus" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                Add Participant
                            </button>
                        </div>
                        
                        <div id="participants-list" class="space-y-3">
                            <!-- Participants will be added here dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Location Information -->
            <div class="border-t border-gray-200 pt-4 sm:pt-6">
                <h4 class="text-sm sm:text-base font-semibold text-gray-900 mb-3 sm:mb-4">Location Information</h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                    <div>
                        <label for="latitude" class="block text-sm font-medium text-gray-700 mb-2">Latitude</label>
                        <input type="text" id="latitude" name="latitude" readonly
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg bg-gray-50 text-gray-600">
                    </div>
                    <div>
                        <label for="longitude" class="block text-sm font-medium text-gray-700 mb-2">Longitude</label>
                        <input type="text" id="longitude" name="longitude" readonly
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg bg-gray-50 text-gray-600">
                    </div>
                    <div class="sm:col-span-2">
                        <div id="map-container" class="w-full h-40 sm:h-48 bg-gray-50 rounded-lg border border-gray-300 flex items-center justify-center">
                            <div class="text-center text-gray-500">
                                <i data-lucide="map" class="w-6 h-6 sm:w-8 sm:h-8 mx-auto mb-2"></i>
                                <p class="text-xs sm:text-sm">Map will appear here once GPS coordinates are captured</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Visit Details -->
            <div class="border-t border-gray-200 pt-4 sm:pt-6">
                <h4 class="text-sm sm:text-base font-semibold text-gray-900 mb-3 sm:mb-4">Visit Details</h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                    <div class="sm:col-span-2">
                        <label for="outcome" class="block text-sm font-medium text-gray-700 mb-2">Visit Outcome <span class="text-red-500">*</span></label>
                        <textarea id="outcome" name="outcome" rows="4" required
                                  class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                  placeholder="Describe the outcome of the visit, discussions held, decisions made, etc."></textarea>
                    </div>
                    
                    <div>
                        <label for="meeting_attendees" class="block text-sm font-medium text-gray-700 mb-2">Meeting Attendees</label>
                        <input type="text" id="meeting_attendees" name="meeting_attendees"
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Names of people present">
                    </div>
                    
                    <div>
                        <label for="visit_duration" class="block text-sm font-medium text-gray-700 mb-2">Visit Duration (minutes)</label>
                        <input type="number" id="visit_duration" name="visit_duration" min="1"
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="e.g., 60">
                    </div>
                </div>
            </div>

            <!-- Follow-up Information -->
            <div class="border-t border-gray-200 pt-4 sm:pt-6">
                <h4 class="text-sm sm:text-base font-semibold text-gray-900 mb-3 sm:mb-4">Follow-up Schedule</h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                    <div>
                        <label for="next_follow_up" class="block text-sm font-medium text-gray-700 mb-2">Next Follow-up Date</label>
                        <input type="date" id="next_follow_up" name="next_follow_up"
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label for="follow_up_method" class="block text-sm font-medium text-gray-700 mb-2">Follow-up Method</label>
                        <select id="follow_up_method" name="follow_up_method"
                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select method</option>
                            <option value="phone">Phone Call</option>
                            <option value="email">Email</option>
                            <option value="visit">Personal Visit</option>
                            <option value="meeting">Meeting</option>
                            <option value="presentation">Presentation</option>
                        </select>
                    </div>
                    
                    <div class="sm:col-span-2">
                        <label for="follow_up_notes" class="block text-sm font-medium text-gray-700 mb-2">Follow-up Notes</label>
                        <textarea id="follow_up_notes" name="follow_up_notes" rows="3"
                                  class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                  placeholder="Specific notes for the next follow-up"></textarea>
                    </div>
                </div>
            </div>

            <!-- Additional Information -->
            <div class="border-t border-gray-200 pt-4 sm:pt-6">
                <h4 class="text-sm sm:text-base font-semibold text-gray-900 mb-3 sm:mb-4">Additional Information</h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                    <div>
                        <label for="expenses" class="block text-sm font-medium text-gray-700 mb-2">Expenses Incurred (₹)</label>
                        <input type="number" id="expenses" name="expenses" min="0" step="0.01"
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Travel, food, etc.">
                    </div>
                    
                    <div>
                        <label for="materials_provided" class="block text-sm font-medium text-gray-700 mb-2">Materials Provided</label>
                        <input type="text" id="materials_provided" name="materials_provided"
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Brochures, samples, etc.">
                    </div>
                    
                    <div class="sm:col-span-2">
                        <label for="additional_notes" class="block text-sm font-medium text-gray-700 mb-2">Additional Notes</label>
                        <textarea id="additional_notes" name="additional_notes" rows="3"
                                  class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                  placeholder="Any other relevant information"></textarea>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex flex-col sm:flex-row items-stretch sm:items-center sm:justify-end gap-3 pt-4 sm:pt-6 border-t border-gray-200">
                <a href="{% url 'marketing:visit_list' %}" class="inline-flex items-center justify-center gap-2 px-4 py-2 text-xs sm:text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                    Cancel
                </a>
                <button type="submit" class="inline-flex items-center justify-center gap-2 rounded-lg bg-blue-600 px-4 sm:px-6 py-2 text-xs sm:text-sm font-medium text-white hover:bg-blue-700 transition-colors">
                    <i data-lucide="save" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                    Record Visit
                </button>
            </div>
        </form>
    </div>

    <!-- Tips Card -->
    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 sm:p-6">
        <div class="flex items-start gap-3">
            <div class="p-2 bg-blue-100 rounded-lg">
                <i data-lucide="lightbulb" class="w-4 h-4 sm:w-5 sm:h-5 text-blue-600"></i>
            </div>
            <div>
                <h4 class="text-sm sm:text-base font-medium text-blue-900 mb-2">Visit Recording Tips</h4>
                <ul class="text-xs sm:text-sm text-blue-800 space-y-1">
                    <li>• Always capture GPS coordinates for accurate location tracking</li>
                    <li>• Be detailed in describing visit outcomes and next steps</li>
                    <li>• Schedule follow-ups promptly to maintain momentum</li>
                    <li>• Record all expenses for reimbursement purposes</li>
                    <li>• Update lead status based on visit outcomes</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
let currentPosition = null;

// Capture GPS coordinates
function captureGPS() {
    const statusDiv = document.getElementById('gps-status');
    const latInput = document.getElementById('latitude');
    const lngInput = document.getElementById('longitude');
    
    if (navigator.geolocation) {
        statusDiv.innerHTML = `
            <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-blue-100 rounded-lg">
                        <i data-lucide="map-pin" class="w-4 h-4 sm:w-5 sm:h-5 text-blue-600"></i>
                    </div>
                    <div class="flex-1">
                        <h4 class="text-sm sm:text-base font-medium text-gray-900">GPS Location</h4>
                        <p class="text-xs sm:text-sm text-gray-600">Capturing your location...</p>
                    </div>
                </div>
            </div>
        `;
        
        navigator.geolocation.getCurrentPosition(function(position) {
            currentPosition = position;
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            
            latInput.value = latitude.toFixed(6);
            lngInput.value = longitude.toFixed(6);
            
            statusDiv.innerHTML = `
                <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-green-100 rounded-lg">
                            <i data-lucide="check-circle" class="w-4 h-4 sm:w-5 sm:h-5 text-green-600"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-sm sm:text-base font-medium text-gray-900">GPS Location Captured</h4>
                            <p class="text-xs sm:text-sm text-gray-600">Lat: ${latitude.toFixed(6)}, Lng: ${longitude.toFixed(6)}</p>
                        </div>
                    </div>
                    <button onclick="captureGPS()" class="inline-flex items-center justify-center gap-2 rounded-lg bg-blue-600 px-3 sm:px-4 py-2 text-xs sm:text-sm font-medium text-white hover:bg-blue-700 transition-colors">
                        <i data-lucide="refresh-cw" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                        Refresh
                    </button>
                </div>
            `;
            
            // Show map
            showMap(latitude, longitude);
            
        }, function(error) {
            statusDiv.innerHTML = `
                <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-red-100 rounded-lg">
                            <i data-lucide="alert-circle" class="w-4 h-4 sm:w-5 sm:h-5 text-red-600"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-sm sm:text-base font-medium text-gray-900">GPS Error</h4>
                            <p class="text-xs sm:text-sm text-gray-600">Unable to capture location. Please check permissions.</p>
                        </div>
                    </div>
                    <button onclick="captureGPS()" class="inline-flex items-center justify-center gap-2 rounded-lg bg-red-600 px-3 sm:px-4 py-2 text-xs sm:text-sm font-medium text-white hover:bg-red-700 transition-colors">
                        <i data-lucide="refresh-cw" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                        Retry
                    </button>
                </div>
            `;
        }, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 300000 // 5 minutes
        });
    } else {
        statusDiv.innerHTML = `
            <div class="flex items-center gap-3">
                <div class="p-2 bg-red-100 rounded-lg">
                    <i data-lucide="alert-circle" class="w-4 h-4 sm:w-5 sm:h-5 text-red-600"></i>
                </div>
                <div class="flex-1">
                    <h4 class="text-sm sm:text-base font-medium text-gray-900">GPS Not Available</h4>
                    <p class="text-xs sm:text-sm text-gray-600">Geolocation is not supported by this browser.</p>
                </div>
            </div>
        `;
    }
}

// Show map with captured coordinates
function showMap(latitude, longitude) {
    const mapContainer = document.getElementById('map-container');
    mapContainer.innerHTML = `
        <div class="w-full h-full bg-gray-50 rounded-lg flex items-center justify-center">
            <div class="text-center text-gray-600">
                <i data-lucide="map-pin" class="w-6 h-6 sm:w-8 sm:h-8 mx-auto mb-2 text-blue-600"></i>
                <p class="text-xs sm:text-sm">Location: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}</p>
                <p class="text-xs text-gray-500 mt-1">Map integration can be added here</p>
            </div>
        </div>
    `;
}

// Auto-set current date and time
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const now = new Date();
    
    // Set current date
    const dateInput = document.getElementById('visit_date');
    if (dateInput) {
        dateInput.value = today.toISOString().split('T')[0];
    }
    
    // Set current time
    const timeInput = document.getElementById('visit_time');
    if (timeInput) {
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        timeInput.value = `${hours}:${minutes}`;
    }
    
    // Auto-set next follow-up date to 3 days from today
    const nextFollowUpInput = document.getElementById('next_follow_up');
    if (nextFollowUpInput) {
        const nextFollowUp = new Date(today);
        nextFollowUp.setDate(today.getDate() + 3);
        nextFollowUpInput.value = nextFollowUp.toISOString().split('T')[0];
    }
    
    // Capture GPS on page load
    captureGPS();
});

// Auto-calculate visit duration
let visitStartTime = null;

function startVisitTimer() {
    visitStartTime = new Date();
}

function endVisitTimer() {
    if (visitStartTime) {
        const endTime = new Date();
        const duration = Math.round((endTime - visitStartTime) / 1000 / 60); // minutes
        document.getElementById('visit_duration').value = duration;
    }
}

// Start timer when form loads
document.addEventListener('DOMContentLoaded', function() {
    startVisitTimer();
});

// Participant management
let participantCount = 0;

function addParticipant() {
    participantCount++;
    const participantsList = document.getElementById('participants-list');
    
    const participantDiv = document.createElement('div');
    participantDiv.className = 'bg-gray-50 border border-gray-200 rounded-lg p-4';
    participantDiv.id = `participant-${participantCount}`;
    
    participantDiv.innerHTML = `
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Participant</label>
                <select name="participants" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Select participant</option>
                    {% for user in users %}
                    <option value="{{ user.id }}">{{ user.get_full_name|default:user.username }} ({{ user.email }})</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                <select name="participant_roles" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="secondary">Secondary Executive</option>
                    <option value="technical">Technical Expert</option>
                    <option value="manager">Manager</option>
                    <option value="observer">Observer</option>
                </select>
            </div>
            <div class="flex items-end">
                <button type="button" onclick="removeParticipant(${participantCount})" class="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-red-600 px-3 py-2 text-xs sm:text-sm font-medium text-white hover:bg-red-700 transition-colors">
                    <i data-lucide="trash-2" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                    Remove
                </button>
            </div>
        </div>
        <div class="mt-3">
            <label class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
            <textarea name="participant_notes" rows="2" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Specific notes about this participant's role in the visit"></textarea>
        </div>
    `;
    
    participantsList.appendChild(participantDiv);
    
    // Re-initialize Lucide icons for the new element
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

function removeParticipant(participantId) {
    const participantDiv = document.getElementById(`participant-${participantId}`);
    if (participantDiv) {
        participantDiv.remove();
    }
}
</script>
{% endblock %}
