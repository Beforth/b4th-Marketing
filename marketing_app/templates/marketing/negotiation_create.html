{% extends 'marketing/base.html' %}
{% load static %}

{% block title %}Create Negotiation - Marketing Hub{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Create Negotiation</h1>
                <p class="text-gray-600 mt-1">Record negotiation details and outcomes</p>
            </div>
            <div class="flex items-center space-x-3">
                <a href="{% url 'marketing:negotiation_list' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                    Back to Negotiations
                </a>
            </div>
        </div>
    </div>

    <!-- Negotiation Form -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <form method="post" enctype="multipart/form-data" class="mx-auto w-full p-2 md:p-4 xl:p-2">
            {% csrf_token %}
            
            <!-- Quotation Selection -->
            <div>
                <label for="quotation" class="block text-sm font-medium text-gray-700 mb-2">Select Quotation <span class="text-red-500">*</span></label>
                <select name="quotation" id="quotation" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Select Shared Quotation</option>
                    {% for quotation in quotations %}
                    <option value="{{ quotation.id }}" data-amount="{{ quotation.total_amount }}">
                        {{ quotation.quotation_number }} - {{ quotation.urs.project_name }}
                    </option>
                    {% endfor %}
                </select>
                <p class="mt-1 text-sm text-gray-500">Only shared quotations are available for negotiation</p>
            </div>

            <!-- Negotiation Details -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="negotiation_date" class="block text-sm font-medium text-gray-700 mb-2">Negotiation Date <span class="text-red-500">*</span></label>
                    <input type="datetime-local" name="negotiation_date" id="negotiation_date" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label for="negotiation_type" class="block text-sm font-medium text-gray-700 mb-2">Negotiation Type <span class="text-red-500">*</span></label>
                    <select name="negotiation_type" id="negotiation_type" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select Type</option>
                        <option value="price">Price Negotiation</option>
                        <option value="terms">Payment Terms</option>
                        <option value="delivery">Delivery Terms</option>
                        <option value="technical">Technical Specifications</option>
                        <option value="comprehensive">Comprehensive</option>
                    </select>
                </div>
            </div>

            <!-- Participants -->
            <div>
                <label for="participants" class="block text-sm font-medium text-gray-700 mb-2">Participants <span class="text-red-500">*</span></label>
                <textarea name="participants" id="participants" rows="2" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="List all participants from both sides"></textarea>
            </div>

            <!-- Pricing Details -->
            <div class="bg-gray-50 rounded-lg p-4 space-y-4">
                <h3 class="text-lg font-medium text-gray-900">Pricing Details</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <label for="initial_offer" class="block text-sm font-medium text-gray-700 mb-2">Initial Offer (₹)</label>
                        <input type="number" name="initial_offer" id="initial_offer" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="0.00">
                    </div>
                    
                    <div>
                        <label for="customer_counter_offer" class="block text-sm font-medium text-gray-700 mb-2">Customer Counter (₹)</label>
                        <input type="number" name="customer_counter_offer" id="customer_counter_offer" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="0.00">
                    </div>
                    
                    <div>
                        <label for="final_offer" class="block text-sm font-medium text-gray-700 mb-2">Final Offer (₹)</label>
                        <input type="number" name="final_offer" id="final_offer" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="0.00">
                    </div>
                </div>
                
                <div>
                    <label for="discount_percentage" class="block text-sm font-medium text-gray-700 mb-2">Discount Percentage (%)</label>
                    <input type="number" name="discount_percentage" id="discount_percentage" step="0.01" min="0" max="100" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="0.00">
                </div>
            </div>

            <!-- Terms -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="payment_terms" class="block text-sm font-medium text-gray-700 mb-2">Payment Terms</label>
                    <textarea name="payment_terms" id="payment_terms" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Negotiated payment terms..."></textarea>
                </div>
                
                <div>
                    <label for="delivery_terms" class="block text-sm font-medium text-gray-700 mb-2">Delivery Terms</label>
                    <textarea name="delivery_terms" id="delivery_terms" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Negotiated delivery terms..."></textarea>
                </div>
            </div>

            <!-- Outcome -->
            <div>
                <label for="outcome" class="block text-sm font-medium text-gray-700 mb-2">Negotiation Outcome <span class="text-red-500">*</span></label>
                <select name="outcome" id="outcome" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Select Outcome</option>
                    <option value="successful">Successful</option>
                    <option value="pending">Pending</option>
                    <option value="failed">Failed</option>
                    <option value="postponed">Postponed</option>
                </select>
            </div>

            <!-- Notes -->
            <div>
                <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                <textarea name="notes" id="notes" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Additional notes, key points discussed, next steps..."></textarea>
            </div>

            <!-- Form Actions -->
            <div class="flex items-center justify-end space-x-4 pt-4 border-t border-gray-200">
                <button type="button" onclick="history.back()" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    Cancel
                </button>
                <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-md shadow-sm text-sm font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Create Negotiation
                </button>
            </div>
        </form>
    </div>

    <!-- Help Section -->
    <div class="bg-blue-50 rounded-lg p-6">
        <h3 class="text-lg font-medium text-blue-900 mb-3">Negotiation Guidelines</h3>
        <div class="text-sm text-blue-800 space-y-2">
            <p><strong>Pricing Strategy:</strong> Start with initial offer, track customer counter-offers, and document final agreed price.</p>
            <p><strong>Discount Management:</strong> Calculate and record any discounts given during negotiation.</p>
            <p><strong>Terms Negotiation:</strong> Document changes to payment and delivery terms.</p>
            <p><strong>Outcome Tracking:</strong> Clearly mark the final outcome of the negotiation process.</p>
            <p><strong>Notes:</strong> Record key discussion points, customer concerns, and next steps.</p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const negotiationDateInput = document.getElementById('negotiation_date');
    const quotationSelect = document.getElementById('quotation');
    const initialOfferInput = document.getElementById('initial_offer');
    const customerCounterInput = document.getElementById('customer_counter_offer');
    const finalOfferInput = document.getElementById('final_offer');
    const discountPercentageInput = document.getElementById('discount_percentage');
    
    // Set default negotiation date to current date and time
    const now = new Date();
    const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
    negotiationDateInput.value = localDateTime;
    
    // Auto-populate initial offer when quotation is selected
    quotationSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const amount = selectedOption.getAttribute('data-amount');
        if (amount) {
            initialOfferInput.value = amount;
        }
    });
    
    // Calculate discount percentage
    function calculateDiscount() {
        const initial = parseFloat(initialOfferInput.value) || 0;
        const final = parseFloat(finalOfferInput.value) || 0;
        
        if (initial > 0 && final > 0) {
            const discount = ((initial - final) / initial) * 100;
            discountPercentageInput.value = discount.toFixed(2);
        }
    }
    
    // Auto-calculate discount when final offer changes
    finalOfferInput.addEventListener('blur', calculateDiscount);
    
    // Auto-save draft functionality
    const form = document.querySelector('form');
    
    setInterval(function() {
        const formElements = form.elements;
        const draftData = {};
        
        for (let element of formElements) {
            if (element.name && element.value) {
                draftData[element.name] = element.value;
            }
        }
        
        localStorage.setItem('negotiation_draft', JSON.stringify(draftData));
    }, 30000);
    
    // Load draft data on page load
    const savedDraft = localStorage.getItem('negotiation_draft');
    if (savedDraft) {
        const draftData = JSON.parse(savedDraft);
        for (let fieldName in draftData) {
            const element = form.elements[fieldName];
            if (element) {
                element.value = draftData[fieldName];
            }
        }
    }
    
    // Clear draft on successful submission
    form.addEventListener('submit', function() {
        localStorage.removeItem('negotiation_draft');
    });
    
    // Format currency inputs
    [initialOfferInput, customerCounterInput, finalOfferInput].forEach(input => {
        input.addEventListener('blur', function() {
            if (this.value) {
                const value = parseFloat(this.value);
                if (!isNaN(value)) {
                    this.value = value.toFixed(2);
                }
            }
        });
    });
    
    // Auto-populate notes template
    const notesField = document.getElementById('notes');
    if (!notesField.value) {
        notesField.value = `Key Points Discussed:
- [Point 1]
- [Point 2]
- [Point 3]

Customer Concerns:
- [Concern 1]
- [Concern 2]

Next Steps:
- [Action 1]
- [Action 2]`;
    }
    
    // Negotiation type change handler
    const negotiationTypeSelect = document.getElementById('negotiation_type');
    negotiationTypeSelect.addEventListener('change', function() {
        const type = this.value;
        const participantsField = document.getElementById('participants');
        
        // Auto-suggest participants based on negotiation type
        if (type === 'price') {
            participantsField.placeholder = "Customer: [Name, Designation]\nOur Team: [Name, Designation]\nFocus: Price and commercial terms";
        } else if (type === 'technical') {
            participantsField.placeholder = "Customer: [Technical Team]\nOur Team: [Technical Team]\nFocus: Technical specifications and requirements";
        } else if (type === 'comprehensive') {
            participantsField.placeholder = "Customer: [All Stakeholders]\nOur Team: [All Stakeholders]\nFocus: Complete project discussion";
        }
    });
});
</script>
{% endblock %}
